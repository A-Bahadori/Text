using System;
using System.Collections.Generic;
using System.Diagnostics;

public class PerformanceTracker
{
    private Stopwatch totalStopwatch;
    private Dictionary<string, TimeSpan> sectionTimes;
    private string currentSection;
    private DateTime sectionStartTime;
    
    public PerformanceTracker()
    {
        totalStopwatch = new Stopwatch();
        sectionTimes = new Dictionary<string, TimeSpan>();
    }
    
    public void Start()
    {
        totalStopwatch.Start();
    }
    
    public void StartSection(string sectionName)
    {
        // اگر بخش قبلی در حال اجراست، آن را به پایان برسان
        if (!string.IsNullOrEmpty(currentSection))
        {
            EndSection();
        }
        
        currentSection = sectionName;
        sectionStartTime = DateTime.Now;
        
        // اگر این بخش قبلاً اندازه‌گیری شده، مقدار آن را صفر کن
        if (sectionTimes.ContainsKey(sectionName))
        {
            sectionTimes[sectionName] = TimeSpan.Zero;
        }
        else
        {
            sectionTimes.Add(sectionName, TimeSpan.Zero);
        }
    }
    
    public void EndSection()
    {
        if (string.IsNullOrEmpty(currentSection))
            return;
            
        TimeSpan elapsed = DateTime.Now - sectionStartTime;
        sectionTimes[currentSection] += elapsed;
        currentSection = null;
    }
    
    public void Stop()
    {
        if (!string.IsNullOrEmpty(currentSection))
        {
            EndSection();
        }
        
        totalStopwatch.Stop();
    }
    
    public void PrintResults()
    {
        Console.WriteLine("=== نتایج اندازه‌گیری عملکرد ===");
        foreach (var section in sectionTimes)
        {
            PrintFormattedTime(section.Key, section.Value);
        }
        PrintFormattedTime("زمان کل", totalStopwatch.Elapsed);
    }
    
    private void PrintFormattedTime(string sectionName, TimeSpan time)
    {
        if (time.TotalSeconds < 0.01) // کمتر از 10 میلی‌ثانیه
        {
            Console.WriteLine($"{sectionName}: {time.TotalMilliseconds:F3} میلی‌ثانیه");
        }
        else if (time.TotalMinutes < 1) // کمتر از یک دقیقه
        {
            Console.WriteLine($"{sectionName}: {time.TotalSeconds:F3} ثانیه");
        }
        else if (time.TotalHours < 1) // کمتر از یک ساعت
        {
            Console.WriteLine($"{sectionName}: {time.Minutes} دقیقه و {time.Seconds} ثانیه");
        }
        else // بیشتر از یک ساعت
        {
            Console.WriteLine($"{sectionName}: {time.Hours} ساعت و {time.Minutes} دقیقه و {time.Seconds} ثانیه");
        }
    }
    
    // گرفتن نتایج به صورت دیکشنری
    public Dictionary<string, TimeSpan> GetResults()
    {
        return new Dictionary<string, TimeSpan>(sectionTimes);
    }
    
    // گرفتن زمان کل
    public TimeSpan GetTotalTime()
    {
        return totalStopwatch.Elapsed;
    }
    
    // نمایش نتایج با فرمت دلخواه
    public void PrintResultsAs(TimeFormat format)
    {
        Console.WriteLine("=== نتایج اندازه‌گیری عملکرد ===");
        foreach (var section in sectionTimes)
        {
            PrintTimeInFormat(section.Key, section.Value, format);
        }
        PrintTimeInFormat("زمان کل", totalStopwatch.Elapsed, format);
    }
    
    private void PrintTimeInFormat(string sectionName, TimeSpan time, TimeFormat format)
    {
        switch (format)
        {
            case TimeFormat.Nanoseconds:
                Console.WriteLine($"{sectionName}: {time.TotalMilliseconds * 1000000:F0} نانوثانیه");
                break;
            case TimeFormat.Microseconds:
                Console.WriteLine($"{sectionName}: {time.TotalMilliseconds * 1000:F0} میکروثانیه");
                break;
            case TimeFormat.Milliseconds:
                Console.WriteLine($"{sectionName}: {time.TotalMilliseconds:F3} میلی‌ثانیه");
                break;
            case TimeFormat.Seconds:
                Console.WriteLine($"{sectionName}: {time.TotalSeconds:F6} ثانیه");
                break;
            case TimeFormat.Minutes:
                Console.WriteLine($"{sectionName}: {time.TotalMinutes:F6} دقیقه");
                break;
            case TimeFormat.Auto:
            default:
                PrintFormattedTime(sectionName, time);
                break;
        }
    }
}

// انواع فرمت‌های زمانی
public enum TimeFormat
{
    Auto,           // انتخاب خودکار بهترین واحد
    Nanoseconds,    // نانوثانیه
    Microseconds,   // میکروثانیه
    Milliseconds,   // میلی‌ثانیه
    Seconds,        // ثانیه
    Minutes         // دقیقه
}

// مثال استفاده
class Program
{
    static void Main(string[] args)
    {
        PerformanceTracker tracker = new PerformanceTracker();
        tracker.Start();
        
        // بخش اول
        tracker.StartSection("مرحله آماده‌سازی داده‌ها");
        ProcessSection1();
        tracker.EndSection();
        
        // بخش دوم
        tracker.StartSection("مرحله پردازش");
        ProcessSection2();
        tracker.EndSection();
        
        // بخش سوم
        tracker.StartSection("مرحله ذخیره‌سازی");
        ProcessSection3();
        tracker.EndSection();
        
        // بخش چهارم (که چندین بار فراخوانی می‌شود)
        for (int i = 0; i < 3; i++)
        {
            tracker.StartSection("بخش تکرارشونده");
            ProcessRepeatedSection();
            tracker.EndSection();
        }
        
        tracker.Stop();
        
        // نمایش نتایج با فرمت‌های مختلف
        Console.WriteLine("\n=== نمایش نتایج با فرمت خودکار ===");
        tracker.PrintResults();
        
        Console.WriteLine("\n=== نمایش نتایج به صورت ثانیه ===");
        tracker.PrintResultsAs(TimeFormat.Seconds);
        
        Console.WriteLine("\n=== نمایش نتایج به صورت میلی‌ثانیه ===");
        tracker.PrintResultsAs(TimeFormat.Milliseconds);
        
        Console.WriteLine("\n=== نمایش نتایج به صورت میکروثانیه ===");
        tracker.PrintResultsAs(TimeFormat.Microseconds);
    }
    
    static void ProcessSection1()
    {
        System.Threading.Thread.Sleep(100);
    }
    
    static void ProcessSection2()
    {
        System.Threading.Thread.Sleep(200);
    }
    
    static void ProcessSection3()
    {
        System.Threading.Thread.Sleep(150);
    }
    
    static void ProcessRepeatedSection()
    {
        System.Threading.Thread.Sleep(50);
    }
}
