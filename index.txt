using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Windows.Forms;

namespace EmojiTextBoxDemo
{
    public partial class Form1 : Form
    {
        private TextBox textBox1;
        private ListBox listBox1;

        // Ù„ÛŒØ³Øª Ø§ÛŒÙ…ÙˆØ¬ÛŒâ€ŒÙ‡Ø§
        private List<string> emojis = new List<string>
        {
            "ğŸ˜€", "ğŸ˜‚", "ğŸ˜", "ğŸ‘", "ğŸ™", "ğŸ‰", "ğŸ’¡", "ğŸ”¥", "ğŸ‚", "ğŸš€",
            "ğŸ˜‰", "ğŸ˜", "ğŸ˜¢", "ğŸ˜¡", "ğŸ¤”", "ğŸ¥³", "ğŸ˜´", "ğŸ˜‡", "ğŸ¤©", "ğŸ¤–"
        };

        public Form1()
        {
            InitializeComponent();
        }

        private void InitializeComponent()
        {
            // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§
            this.textBox1 = new TextBox();
            this.listBox1 = new ListBox();

            // 
            // textBox1
            // 
            this.textBox1.Font = new Font("Segoe UI", 12F, FontStyle.Regular, GraphicsUnit.Point);
            this.textBox1.Location = new Point(12, 12);
            this.textBox1.Width = 400;
            this.textBox1.KeyUp += textBox1_KeyUp;
            // 
            // listBox1
            // 
            this.listBox1.Font = new Font("Segoe UI", 12F, FontStyle.Regular, GraphicsUnit.Point);
            this.listBox1.Visible = false;
            this.listBox1.Height = 150;
            this.listBox1.Click += listBox1_Click;
            this.listBox1.KeyDown += listBox1_KeyDown;

            // 
            // Form1
            // 
            this.ClientSize = new Size(430, 200);
            this.Controls.Add(this.textBox1);
            this.Controls.Add(this.listBox1);
            this.Text = "Emoji Picker Demo";
        }

        // Ù‡Ù†Ú¯Ø§Ù… Ø¢Ø²Ø§Ø¯ Ø´Ø¯Ù† Ú©Ù„ÛŒØ¯ Ø¯Ø± TextBox
        private void textBox1_KeyUp(object sender, KeyEventArgs e)
        {
            string word = GetCurrentWord(textBox1);
            if (word.StartsWith(":"))
            {
                string query = word.Substring(1).ToLower();
                var matches = emojis
                    .Where(emo => GetEmojiName(emo).Contains(query) || emo.Contains(query))
                    .ToList();

                if (matches.Any())
                {
                    listBox1.DataSource = matches;
                    PositionListBox();
                    listBox1.Visible = true;
                }
                else
                {
                    listBox1.Visible = false;
                }
            }
            else
            {
                listBox1.Visible = false;
            }
        }

        // Ú¯Ø±ÙØªÙ† Ú©Ù„Ù…Ù‡ Ø¬Ø§Ø±ÛŒ (Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† ÙØ§ØµÙ„Ù‡ ØªØ§ Ù…Ú©Ø§Ù†â€ŒÙ†Ù…Ø§)
        private string GetCurrentWord(TextBox tb)
        {
            int pos = tb.SelectionStart;
            string textUpToCursor = tb.Text.Substring(0, pos);
            int lastSpace = textUpToCursor.LastIndexOf(' ');
            return lastSpace >= 0
                ? textUpToCursor.Substring(lastSpace + 1)
                : textUpToCursor;
        }

        // Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒØ¯Ù‡ÛŒ ListBox Ø²ÛŒØ± Ù…Ú©Ø§Ù†â€ŒÙ†Ù…Ø§
        private void PositionListBox()
        {
            int idx = textBox1.SelectionStart;
            Point p = textBox1.GetPositionFromCharIndex(idx);
            p.Y += (int)Math.Ceiling(textBox1.Font.GetHeight()) + 5;
            Point screen = textBox1.PointToScreen(p);
            Point client = this.PointToClient(screen);

            listBox1.Location = client;
            listBox1.Width = 150;
        }

        // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¢ÛŒØªÙ… Ù„ÛŒØ³Øª
        private void listBox1_Click(object sender, EventArgs e)
        {
            InsertSelectedEmoji();
        }

        // Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Enter Ùˆ Escape Ø¯Ø± ListBox
        private void listBox1_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                InsertSelectedEmoji();
                e.Handled = true;
            }
            else if (e.KeyCode == Keys.Escape)
            {
                listBox1.Visible = false;
                e.Handled = true;
            }
        }

        // Ø¯Ø±Ø¬ Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø¯Ø± TextBox
        private void InsertSelectedEmoji()
        {
            if (listBox1.SelectedItem == null) return;
            string emoji = listBox1.SelectedItem.ToString();

            int selStart = textBox1.SelectionStart;
            string word = GetCurrentWord(textBox1);
            int wordLen = word.Length;

            textBox1.Text = textBox1.Text
                .Remove(selStart - wordLen, wordLen)
                .Insert(selStart - wordLen, emoji);

            textBox1.SelectionStart = selStart - wordLen + emoji.Length;
            listBox1.Visible = false;
            textBox1.Focus();
        }

        // Ø¯Ø± ØµÙˆØ±Øª ØªÙ…Ø§ÛŒÙ„ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ø§Ø´Øª Ø§Ø³Ù… Ø¨Ù‡ Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø¨Ø³Ø· Ø¯Ù‡ÛŒØ¯
        private string GetEmojiName(string emoji)
        {
            // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ Ø§ÛŒÙ†Ø¬Ø§ ÙÙ‚Ø· Ù‡Ù…Ø§Ù† Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            // Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ© Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ø§Ø² Ù†Ø§Ù…â€ŒÙ‡Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯ Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
            return emoji;
        }
    }
}
