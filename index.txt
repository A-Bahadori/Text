using System;
using System.Collections.Generic;
using System.IO;
using System.Threading;
using Gurock.SmartInspect;

namespace SmartInspectSample
{
    // Logger management class using Singleton pattern
    public static class SILogger
    {
        private static readonly SmartInspect _si;
        private static readonly Session _session;
        
        static SILogger()
        {
            _si = new SmartInspect("SILogger");
            
            // Default settings
            _si.Connections = "file(filename=\"D:\\SmartInspectTest\\AppLog.sil\", rotate=daily)";
            _si.Level = Level.Debug;
            _si.Enabled = true;
            
            _session = _si.AddSession("Main");
        }
        
        public static Session MainSession
        {
            get { return _session; }
        }
        
        public static void Configure(string connections, Level level = Level.Debug)
        {
            _si.Connections = connections;
            _si.Level = level;
        }
        
        public static void SetEnabled(bool enabled)
        {
            _si.Enabled = enabled;
        }
        
        public static void LogMethodEntry(string methodName)
        {
            _session.EnterMethod(methodName);
        }
        
        public static void LogMethodExit(string methodName)
        {
            _session.LeaveMethod(methodName);
        }
        
        public static void LogInfo(string message)
        {
            _session.LogMessage(message);
        }
        
        public static void LogMessage(string message)
        {
            _session.LogMessage(message);
        }
        
        public static void LogWarning(string message)
        {
            _session.LogWarning(message);
        }
        
        public static void LogError(string message, Exception ex = null)
        {
            if (ex != null)
            {
                _session.LogException(message, ex);
            }
            else
            {
                _session.LogError(message);
            }
        }
        
        public static void LogDebug(string message)
        {
            _session.LogDebug(message);
        }
        
        public static void LogInteger(string title, int value)
        {
            // Using LogMessage instead of LogInteger which might not be available
            _session.LogMessage($"{title}: {value}");
        }
        
        public static void LogString(string title, string value)
        {
            // Using LogMessage instead of LogString which might not be available
            _session.LogMessage($"{title}: {value}");
        }
        
        public static void LogValue(string title, object value)
        {
            // Using LogMessage for values as LogValue might not be available
            _session.LogMessage($"{title}: {value?.ToString() ?? "(null)"}");
        }
        
        public static void LogBoolean(string title, bool value)
        {
            _session.LogMessage($"{title}: {value}");
        }
        
        public static void LogText(string title, string value)
        {
            // Use LogMessage instead of LogText which might not be available
            _session.LogMessage($"{title}: {value}");
        }
        
        public static void LogObject(string title, object value)
        {
            // Since LogObject is not directly available in older versions, we can log properties manually
            _session.LogMessage($"--- {title} ---");
            
            if (value == null)
            {
                _session.LogMessage("(null)");
                return;
            }
            
            foreach (var prop in value.GetType().GetProperties())
            {
                try
                {
                    var propValue = prop.GetValue(value, null);
                    _session.LogMessage($"{prop.Name}: {propValue?.ToString() ?? "(null)"}");
                }
                catch
                {
                    _session.LogMessage($"{prop.Name}: (error getting value)");
                }
            }
        }
        
        public static void BeginTimedOperation(string operationName)
        {
            _session.EnterMethod(operationName);
            _session.LogMessage($"Start Time: {DateTime.Now}");
        }
        
        public static void EndTimedOperation(string operationName, DateTime startTime)
        {
            TimeSpan elapsed = DateTime.Now - startTime;
            _session.LogMessage($"Elapsed Time (ms): {elapsed.TotalMilliseconds}");
            _session.LeaveMethod(operationName);
        }
    }
    
    // Example classes for use in samples
    public class Customer
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Email { get; set; }
        public string Phone { get; set; }
    }
    
    public class Product
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public decimal Price { get; set; }
        public int Quantity { get; set; }
    }
    
    public class Order
    {
        public int Id { get; set; }
        public Customer Customer { get; set; }
        public List<Product> Products { get; set; }
        public DateTime OrderDate { get; set; }
        
        public Order()
        {
            Products = new List<Product>();
        }
    }
    
    // Service classes for practical examples
    public class DataService
    {
        public Customer GetCustomer(int id)
        {
            SILogger.LogMethodEntry("GetCustomer");
            try 
            {
                SILogger.LogInfo($"Customer ID: {id}");
                
                // Simulate retrieving customer from database
                if (id <= 0)
                {
                    SILogger.LogWarning("Invalid customer ID provided");
                    return null;
                }
                
                Thread.Sleep(100); // Simulate database access delay
                
                var customer = new Customer
                {
                    Id = id,
                    Name = $"Customer {id}",
                    Email = $"customer{id}@example.com",
                    Phone = $"09{id.ToString().PadLeft(9, '1')}"
                };
                
                SILogger.LogObject("Retrieved Customer", customer);
                return customer;
            }
            catch (Exception ex)
            {
                SILogger.LogError("Error retrieving customer", ex);
                throw;
            }
            finally
            {
                SILogger.LogMethodExit("GetCustomer");
            }
        }
        
        public List<Product> GetProducts(int count)
        {
            SILogger.LogMethodEntry("GetProducts");
            try
            {
                SILogger.LogInfo($"Requested Count: {count}");
                
                if (count <= 0)
                {
                    SILogger.LogWarning("Invalid product count requested");
                    return new List<Product>();
                }
                
                var products = new List<Product>();
                for (int i = 1; i <= count; i++)
                {
                    Thread.Sleep(50); // Simulate delay
                    
                    var product = new Product
                    {
                        Id = i,
                        Name = $"Product {i}",
                        Price = i * 10000,
                        Quantity = 10
                    };
                    
                    products.Add(product);
                    SILogger.LogInfo($"Added Product: {product.Name}");
                }
                
                SILogger.LogInfo($"Products Retrieved: {products.Count}");
                return products;
            }
            catch (Exception ex)
            {
                SILogger.LogError("Error retrieving products", ex);
                throw;
            }
            finally
            {
                SILogger.LogMethodExit("GetProducts");
            }
        }
        
        public bool SaveOrder(Order order)
        {
            SILogger.LogMethodEntry("SaveOrder");
            DateTime startTime = DateTime.Now;
            
            try
            {
                if (order == null)
                {
                    SILogger.LogError("Null order provided");
                    return false;
                }
                
                SILogger.LogObject("Order Info", order);
                SILogger.LogObject("Customer Info", order.Customer);
                
                SILogger.LogInfo("Saving products:");
                foreach (var product in order.Products)
                {
                    SILogger.LogObject($"Product {product.Id}", product);
                    Thread.Sleep(20); // Simulate product saving
                }
                
                // Simulate order saving
                Thread.Sleep(200);
                
                SILogger.LogInfo("Order saved successfully");
                return true;
            }
            catch (Exception ex)
            {
                SILogger.LogError("Error saving order", ex);
                return false;
            }
            finally
            {
                TimeSpan elapsed = DateTime.Now - startTime;
                SILogger.LogInfo($"Save Operation Duration (ms): {elapsed.TotalMilliseconds}");
                SILogger.LogMethodExit("SaveOrder");
            }
        }
    }
    
    public class FileProcessor
    {
        public void ProcessFile(string filePath)
        {
            SILogger.LogMethodEntry("ProcessFile");
            
            try
            {
                SILogger.LogInfo($"File Path: {filePath}");
                
                if (string.IsNullOrEmpty(filePath))
                {
                    SILogger.LogError("Empty file path provided");
                    return;
                }
                
                if (!File.Exists(filePath))
                {
                    SILogger.LogError($"File not found: {filePath}");
                    return;
                }
                
                // Log file information
                var fileInfo = new FileInfo(filePath);
                SILogger.LogInfo($"File Size (bytes): {fileInfo.Length}");
                SILogger.LogInfo($"Creation Time: {fileInfo.CreationTime}");
                
                // Log file content (for text files)
                if (fileInfo.Extension.ToLower() == ".txt" || fileInfo.Extension.ToLower() == ".log")
                {
                    // Using file reading approach instead of LogFile
                    SILogger.LogInfo($"File Content: {filePath}");
                    try {
                        string content = File.ReadAllText(filePath);
                        SILogger.LogInfo(content);
                    }
                    catch (Exception ex) {
                        SILogger.LogError($"Error reading file: {ex.Message}");
                    }
                }
                
                // Simulate file processing
                SILogger.LogInfo("Processing file contents...");
                Thread.Sleep(300);
                
                SILogger.LogInfo("File processing completed");
            }
            catch (Exception ex)
            {
                SILogger.LogError("Error processing file", ex);
            }
            finally
            {
                SILogger.LogMethodExit("ProcessFile");
            }
        }
    }
    
    // Main program class containing all examples
    class Program
    {
        private static readonly DataService _dataService = new DataService();
        private static readonly FileProcessor _fileProcessor = new FileProcessor();
        
        static void Main(string[] args)
        {
            try
            {
                // Initial SmartInspect configuration
                InitializeSmartInspect();
                
                // Various examples of using SmartInspect
                BasicLoggingExample();
                ExceptionHandlingExample();
                PerformanceMeasurementExample();
                DataStructuresExample();
                FileOperationsExample();
                DatabaseOperationSimulationExample();
                
                Console.WriteLine("All logging operations completed successfully.");
                Console.WriteLine("Logs are saved in D:\\SmartInspectTest\\AppLog.sil.");
                Console.WriteLine("To view details, open the SmartInspect Console application.");
                Console.ReadKey();
            }
            catch (Exception ex)
            {
                SILogger.LogError("General application error", ex);
                Console.WriteLine($"Error: {ex.Message}");
            }
            finally
            {
                // Close SmartInspect
                SILogger.SetEnabled(false);
            }
        }
        
        private static void InitializeSmartInspect()
        {
            // Initial SmartInspect setup - already configured in SILogger
            SILogger.Configure("file(filename=\"D:\\SmartInspectTest\\AppLog.sil\", " +
                             "rotate=daily, maxsize=10mb, maxparts=5)", Level.Debug);
            
            // Record program start
            SILogger.LogInfo("===== Program Started =====");
            SILogger.LogInfo("System Information: " + Environment.OSVersion.ToString());
        }
        
        private static void BasicLoggingExample()
        {
            SILogger.LogMethodEntry("BasicLoggingExample");
            
            try
            {
                SILogger.LogInfo("Example 1: Basic Logging Examples");
                
                // Logs with different levels
                SILogger.LogDebug("This is a debug message");
                SILogger.LogInfo("This is a normal message");
                SILogger.LogWarning("This is a warning");
                SILogger.LogError("This is an error (example)");
                
                // Log different data types
                SILogger.LogInfo($"Integer: {42}");
                SILogger.LogInfo($"String: {"Sample text"}");
                SILogger.LogInfo($"Boolean: {true}");
                SILogger.LogInfo($"Date and Time: {DateTime.Now}");
            }
            finally
            {
                SILogger.LogMethodExit("BasicLoggingExample");
            }
        }
        
        private static void ExceptionHandlingExample()
        {
            SILogger.LogMethodEntry("ExceptionHandlingExample");
            
            try
            {
                SILogger.LogInfo("Example 2: Exception Handling");
                
                try
                {
                    // Create an intentional exception
                    SILogger.LogInfo("Attempting to divide by zero...");
                    int divisor = 0; // Set to zero at runtime to force exception
                    int result = 10 / divisor; // Create exception
                }
                catch (DivideByZeroException ex)
                {
                    // Log exception
                    SILogger.LogError("Division by zero error", ex);
                }
                
                try
                {
                    // Another exception
                    SILogger.LogInfo("Attempting to access array out of bounds...");
                    int[] numbers = new int[3];
                    int value = numbers[10]; // Create exception
                }
                catch (IndexOutOfRangeException ex)
                {
                    // Log exception
                    SILogger.LogError("Array access error", ex);
                }
            }
            finally
            {
                SILogger.LogMethodExit("ExceptionHandlingExample");
            }
        }
        
        private static void PerformanceMeasurementExample()
        {
            SILogger.LogMethodEntry("PerformanceMeasurementExample");
            DateTime startTime = DateTime.Now;
            
            try
            {
                SILogger.LogInfo("Example 3: Runtime Measurement");
                
                // Measure time of a simple operation
                DateTime operationStart = DateTime.Now;
                
                SILogger.LogInfo("Starting time-consuming operation...");
                Thread.Sleep(1500); // Simulate a time-consuming operation
                SILogger.LogInfo("Time-consuming operation complete");
                
                TimeSpan operationTime = DateTime.Now - operationStart;
                SILogger.LogInfo($"Operation execution time (milliseconds): {operationTime.TotalMilliseconds}");
                
                // Measure loop time
                operationStart = DateTime.Now;
                
                int sum = 0;
                for (int i = 0; i < 1000000; i++)
                {
                    sum += i;
                }
                
                operationTime = DateTime.Now - operationStart;
                SILogger.LogInfo($"Calculated sum: {sum}");
                SILogger.LogInfo($"Calculation time (milliseconds): {operationTime.TotalMilliseconds}");
            }
            finally
            {
                TimeSpan totalTime = DateTime.Now - startTime;
                SILogger.LogInfo($"Total time (milliseconds): {totalTime.TotalMilliseconds}");
                SILogger.LogMethodExit("PerformanceMeasurementExample");
            }
        }
        
        private static void DataStructuresExample()
        {
            SILogger.LogMethodEntry("DataStructuresExample");
            
            try
            {
                SILogger.LogInfo("Example 4: Logging Data Structures");
                
                // Log array
                int[] numbers = { 1, 2, 3, 4, 5 };
                SILogger.LogInfo("Numbers array:");
                for (int i = 0; i < numbers.Length; i++)
                {
                    SILogger.LogInfo($"numbers[{i}]: {numbers[i]}");
                }
                
                // Log list
                List<string> names = new List<string> { "Alex", "Michael", "Robert", "John" };
                SILogger.LogInfo("Names list:");
                for (int i = 0; i < names.Count; i++)
                {
                    SILogger.LogInfo($"names[{i}]: {names[i]}");
                }
                
                // Log dictionary
                Dictionary<string, int> scores = new Dictionary<string, int>
                {
                    { "Alex", 85 },
                    { "Michael", 92 },
                    { "Robert", 78 },
                    { "John", 90 }
                };
                
                SILogger.LogInfo("Scores:");
                foreach (var entry in scores)
                {
                    SILogger.LogInfo($"Score {entry.Key}: {entry.Value}");
                }
                
                // Log class
                var customer = new Customer
                {
                    Id = 1,
                    Name = "Michael Smith",
                    Email = "michael@example.com",
                    Phone = "09123456789"
                };
                
                SILogger.LogInfo("Customer Information:");
                SILogger.LogInfo($"ID: {customer.Id}");
                SILogger.LogInfo($"Name: {customer.Name}");
                SILogger.LogInfo($"Email: {customer.Email}");
                SILogger.LogInfo($"Phone: {customer.Phone}");
            }
            finally
            {
                SILogger.LogMethodExit("DataStructuresExample");
            }
        }
        
        private static void FileOperationsExample()
        {
            SILogger.LogMethodEntry("FileOperationsExample");
            
            try
            {
                SILogger.LogInfo("Example 5: File Operations");
                
                // Create a temporary text file for testing
                string tempFilePath = Path.Combine(Path.GetTempPath(), "smartinspect_test.txt");
                
                try
                {
                    // Write to file
                    SILogger.LogInfo($"File path: {tempFilePath}");
                    SILogger.LogInfo("Creating file...");
                    
                    File.WriteAllText(tempFilePath, "This is a test file for SmartInspect.\r\n" +
                                                  "Second line of the test file.\r\n" +
                                                  "Third line of the test file.");
                    
                    SILogger.LogInfo("File created successfully");
                    
                    // Display file information
                    FileInfo fileInfo = new FileInfo(tempFilePath);
                    SILogger.LogInfo($"File size (bytes): {fileInfo.Length}");
                    SILogger.LogInfo($"Creation time: {fileInfo.CreationTime}");
                    
                    // Log file content
                    SILogger.LogInfo($"File content: {tempFilePath}");
                    try {
                        string content = File.ReadAllText(tempFilePath);
                        SILogger.LogInfo(content);
                    }
                    catch (Exception ex) {
                        SILogger.LogError($"Error reading file: {ex.Message}");
                    }
                    
                    // Read and log file content manually
                    string[] lines = File.ReadAllLines(tempFilePath);
                    SILogger.LogInfo($"Number of lines: {lines.Length}");
                    
                    for (int i = 0; i < lines.Length; i++)
                    {
                        SILogger.LogInfo($"Line {i+1}: {lines[i]}");
                    }
                    
                    // Process file using FileProcessor class
                    _fileProcessor.ProcessFile(tempFilePath);
                }
                finally
                {
                    // Delete temporary file
                    if (File.Exists(tempFilePath))
                    {
                        File.Delete(tempFilePath);
                        SILogger.LogInfo("Temporary file deleted");
                    }
                }
            }
            catch (Exception ex)
            {
                SILogger.LogError("Error in file operations", ex);
            }
            finally
            {
                SILogger.LogMethodExit("FileOperationsExample");
            }
        }
        
        private static void DatabaseOperationSimulationExample()
        {
            SILogger.LogMethodEntry("DatabaseOperationSimulationExample");
            
            try
            {
                SILogger.LogInfo("Example 6: Database Operation Simulation");
                
                // Simulate a complete database operation
                
                // 1. Get customer
                Customer customer = _dataService.GetCustomer(123);
                
                if (customer == null)
                {
                    SILogger.LogError("Customer not found");
                    return;
                }
                
                // 2. Get products
                List<Product> products = _dataService.GetProducts(3);
                
                if (products.Count == 0)
                {
                    SILogger.LogError("No products found");
                    return;
                }
                
                // 3. Create order
                var order = new Order
                {
                    Id = 1001,
                    Customer = customer,
                    Products = products,
                    OrderDate = DateTime.Now
                };
                
                // 4. Calculate and log order total
                decimal total = 0;
                SILogger.LogInfo("Calculating order total:");
                
                foreach (var product in order.Products)
                {
                    decimal itemTotal = product.Price * product.Quantity;
                    SILogger.LogInfo($"Product {product.Id}: {product.Name} - {itemTotal}");
                    total += itemTotal;
                }
                
                SILogger.LogInfo($"Final total: {total}");
                
                // 5. Save order
                bool saveResult = _dataService.SaveOrder(order);
                
                SILogger.LogInfo($"Order save result: {saveResult}");
                
                if (saveResult)
                {
                    SILogger.LogInfo("Order saved successfully");
                }
                else
                {
                    SILogger.LogError("Error saving order");
                }
            }
            catch (Exception ex)
            {
                SILogger.LogError("Error in database operation simulation", ex);
            }
            finally
            {
                SILogger.LogMethodExit("DatabaseOperationSimulationExample");
            }
        }
    }
}
